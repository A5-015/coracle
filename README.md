# Coracle ![coracle Clipart courtesy FCIT](https://cloud.githubusercontent.com/assets/1835251/8544604/8d3fdee6-249e-11e5-8ae3-0ee6d73028dd.png) 

Welcome to Coracle, a consensus algorithm simulator for heterogeneous networks.

______

#### Installation

An install script can be found in [scripts/install.sh](scripts/install.sh). The general process is as follows:

Start off by installing OPAM/OCaml, here's some helpful links:
* https://opam.ocaml.org/doc/Install.html
* https://github.com/realworldocaml/book/wiki/Installation-Instructions

Using OPAM we can get the project dependencies:
```
opam update
opam upgrade
opam install cstruct ipaddr lwt sexplib cmdline yojson
```

And then compile from source as follows:

```
git clone https://github.com/heidi-ann/coracle
cd coracle

ocaml setup.ml -configure
ocaml setup.ml -build
ocaml setup.ml -install
```

Now to setup the node web server:

```
brew install npm
npm install express serve-favicon morgan cookie-parser node-uuid debug jade serve-index moment
cd coracle/web
mkdir requests
PORT=3000 node ./bin/www
```
Replacing brew with your package manager of course. Setting up supervisor can allow the server to auto update when files change.


An update script can be found in [scripts/update.sh](scripts/update.sh).

______

#### Usage

We currently support two interfaces: command line implementation and simulation.

##### Implementation

Run an consensus algorithm as follows:
```
./coracle_unix.byte 1 --max=5
```
This instance will bind locally to port 5001 (5000+id) and will try to communicate with other instances at ports 5000 to 5004 (5000 to 5000+max-1).

##### Simulation

Ran a simulation as follows:
```
./coracle_sim.byte -n 5
```
This will ran a simualator with 5 nodes.

##### Bugs

Please send any comments, questions or bugs to GitHub issue tracker:

https://github.com/consensus-oracle/coracle/issues

##### License

This code is released under the MIT License, see the [LICENSE](LICENSE) file for full details.

Coracle clipart courtesy of [FCIT](http://etc.usf.edu/clipart/) for non-commercial use only 
______

#### Contribute

This project is in the early development stages and we plan to have the first prototype release ready for [SIGCOMM '15](http://conferences.sigcomm.org/sigcomm/2015/) on 17th Aug 2015. Contributions are welcome, these are best make via pull requests and using Github issues to mark that your working on a particular issues or features. 

The current codebase is structured as follows:

* [lib/](lib) - common functionality used by all consensus implementations
  * [common.ml(i)](lib/common.ml) - simple useful functions for use throughout
  * [io.ml(i)](lib/io.ml) - type definitions for protocol and frontend interface
  * [numbergen.ml(i)](lib/numbergen.ml) - generator for random numbers within a given distribution
  * [protocol.ml(i)](lib/protocol.ml) - module sig for general consensus algorithms
* [raft/](raft) - pure raft consensus implementation
  * [election.ml(i)](raft/election.ml) - raft election code
  * [election_io.ml(i)](raft/election.ml) - raft election interface, packets and timeouts
  * [event.ml(i)](raft/event.ml) - main eval loop for raft protocol
  * [raft.ml(i)](raft/raft.ml) - wrapping raft consensus ready for the CONSENSUS sig
  * [rpcs.ml(i)](raft/rpcs.ml) - raft RPC representations as records plus serialize/deserialize
  * [state.ml(i)](raft/state.ml) - raft internal state and operators
* [unix/](unix) - unix frontend for consensus protocols
  * [client.ml(i)](unix\client.ml) - empty
  * [coracle_unix.ml(i)](unix/coracle_unix.ml) - parsing command line arguments for unix interface
  * [id.ml(i)](unix/id.ml) - handling node ID's
  * [io_handlers.ml(i)](unix/io_handlers.ml) - main body of unix interface
* [sim/](sim) - simulation frontend for coracle
  * [coracle_sim.ml(i)](sim/coracle_sim.ml) - parsing command line arguments for simulation interface
  * [events.ml(i)](sim/events.ml) - handling events and their applications
  * [parameters.ml(i)](sim/parameters.ml) - type sig for simulation parameters
  * [simulator.ml(i)](sim/simulator.ml) - simulators main loop
  * [states.ml(i)](sim/states.ml) - handling multiple node state
* [scripts/](scripts) deployment scripts for demo server
  * [install.sh](scripts/install.sh) - script to install coracle on demo server
  * [update.sh](scripts/update.sh) -  script to pull code/library updates
* [sample_config.json](sample_config.json) - sample coracle_sim configuration in JSON
* [_oasis](_oasis) - configuration file for the [OASIS](http://oasis.forge.ocamlcore.org/) build system
* [_tags](_tags), [myocamlbuild.ml](myocamlbuild.ml), [setup.ml](setup.ml) - files auto generated by OASIS, included so that OASIS is not a project dependency
* META, *.mlylib, *.mllib, *.mlpack - files auto generated by OASIS during packing

#### Plan (19/7)
- [x] Simple prototype JS frontend
  - [x] user selectes between raft and vrr, number of nodes, number of secs to simulate and main timeout parameter
  - [x] intermediate service runs OCaml simulator process with parameters expressed in JSON
  - [x] OCaml simulator process terminates returning simulation stats in JSON
  - [x] stats are displayed to the user
- [x] Abstract over Consensus algorithms
- [x] Parsing simulation config in JSON
- [x] Terminating simulation at specified time
- [x] Server side parameter validation of configurations from JSON
- [x] Client side parameter validation of configurations from JSON
- [x] Advanced setting section for each protocol, hidden by default
- [x] Random seed field, default is randomly generated by JS but value can be changed
- [x] Setup coracle on demo on Azure

#### Plan (26/7)
This week focuses on supporting clients and VRR.

###### Common backend
- [x] Remove redundency in parsing logic between the JSON and command line interfaces
- [x] Adding protocol specific parameters

###### Raft
- [x] Support AppendEntries


###### VRR
- [ ] Implement basic VRR (assuming access to persistent storage)


###### Simulation frontend (OCaml)
- [x] Allow random seed to be set by JSON/command line interface

###### Simulation frontend (JS)
- [ ] Adding tabs (or similar) to make more space on the page e.g. seperate 'parmeters' and 'results' tabs and seperate 'general', 'raft' and 'vrr' tabs within the 'parameters page'
- [ ] Change JSON file naming from UUID to date,time,seed

###### Demo \& Housekeeping
- [ ] Add web demo setup instruction to Readme
- [ ] add web/ and other file change to file overview in Readme

#### Plan (2/8)
This week focuses on supporting inputting heterozygous networks and supporting clients.

###### Common backend
- [ ] Support for simulated node failure
- [ ] Adding support for client and client based events

###### Raft
- [ ] Support Client Interation

###### VRR

###### Simulation frontend (OCaml)
- [ ] Ability to store and query hetrozengous networks, later labelled with parameters like node failure rates, link direction, link latency, probability of packet loss, bandwidth etc..
- [ ] Support for simulating clients
- [ ] Support for basic client workload

###### Simulation frontend (JS)
- [ ] Allow the user to select between a set of sample network topologies
- [ ] Allow the user to draw static network topologies and label it
- [ ] Basic client support 
  - [ ] parameter to set number of clients
  - [ ] parameter to set regularly of client requires

###### Demo \& Housekeeping

#### Plan (9/8)
This week focuses on presenting simulation results.

###### Common backend


###### Raft

###### VRR

###### Simulation frontend (OCaml)

###### Simulation frontend (JS)
- [ ] Return results as graphs instead of just a table of stats

###### Demo \& Housekeeping

#### Plan (16/8)
This week focuses on getting demo ready. 

###### Common backend
- [ ] Try using mutable event queue

###### Raft
- [ ] Support for Read-only Comamnds
- [ ] Configurable hearbeat interval and heartbeat timer

###### VRR

###### Simulation frontend (OCaml)
- [ ] Allow simulated/random/uniform client workloads

###### Simulation frontend (JS)
- [ ] Provide some specific example workloads
- [ ] Allow the user to run multi simulations at once

##### Demo \& Housekeeping
- [ ] Adding Travis-CI support
- [ ] Choose and implement a logging solution throughout code base, syslog compatible
- [ ] add coracle to OPAM
- [ ] add copyright/license notice to each file header
- [ ] add ocaml 4.02.2 support (fix inconsistent interface error)
- [ ] Register coracle domain
- [ ] Test demo server and possiblity add use multiple machines/processes for load balancing

______

#### Ideas for future features

- [ ] Support for other consensus protocols such as original Paxos, Zab or EPaxos
- [ ] Dynamic membership implementation for Raft and VRR plus abiliy to test in simulation
- [ ] MirageOS frontend 
- [ ] Complete JS implementation using js_of_ocaml
- [ ] Support for non-ocaml consensus protocols
- [ ] Support for simulating dynamic network topologies
- [ ] Split this code into 3 or 4 seperate repositories 
- [ ] Unix frontend
  - [ ] Decople server id and port/host address
  - [ ] Support for config files, with a subset of [logcabin's options](https://github.com/logcabin/logcabin/blob/master/sample.conf).
  - [ ] Support for state machines as a seperate process (or even on an separate host), comms via sockets/pipes/ other IPCs
  - [ ] Proper client side executable with suuport for an application as a separate process
  - [ ] Really support for persistent storage, with write-ahead logging
  - [ ] Add a download configuration option, which provides the current configuration as a JSON file and reference to github issue tracker.
  - [ ] Add a reset button to reset feilds to original values
- [ ] method to generate a random workload and then reuse it for other simulations
- [ ] Allow multiple simulation configuration per run, so instead of one Raft configuration and one VRR configuration, the user can upto 5 configurations. This could be used to run 
